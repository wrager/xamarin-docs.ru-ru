---
title: HealthKit
description: "HealthKit — это платформа, представленные в iOS 8, обеспечивающий централизованное, координации и безопасного хранилища данных сведения о работоспособности. Операционная система гарантирует конфиденциальность и безопасность информации о состоянии и с помощью работоспособности приложения панели мониторинга для пользователя. С разрешения пользователя приложения могут читать и записывать различные сведения о работоспособности."
ms.topic: article
ms.prod: xamarin
ms.assetid: E3927A21-507C-43BA-A2AD-957716BA9B52
ms.technology: xamarin-ios
author: bradumbaugh
ms.author: brumbaug
ms.date: 03/19/2017
ms.openlocfilehash: 4f85f208c12561b6db9800d963e2d7bf32c2a4d0
ms.sourcegitcommit: 30055c534d9caf5dffcfdeafd6f08e666fb870a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/09/2018
---
# <a name="healthkit"></a>HealthKit

_HealthKit — это платформа, представленные в iOS 8, обеспечивающий централизованное, координации и безопасного хранилища данных сведения о работоспособности. Операционная система гарантирует конфиденциальность и безопасность информации о состоянии и с помощью работоспособности приложения панели мониторинга для пользователя. С разрешения пользователя приложения могут читать и записывать различные сведения о работоспособности._

Комплект работоспособности предоставляет безопасное хранилище данных с работоспособностью сведения пользователя. Работоспособности комплект средств для приложений с явные разрешения пользователя, чтения и записи для этого хранилища данных и получать уведомления при добавлении данных. Приложения могут запрашивать данные или пользователя для просмотра панели мониторинга всех данных можно использовать предоставленный работоспособности приложения компании Apple.

Из-за здоровья данных таким образом конфиденциальные и большое значение, комплект работоспособности является строго типизированным, с использованием единиц измерения и явную связь с типом записываются сведения (для экземпляра уровень глюкоза крови или пульс). Кроме того комплект работоспособности приложения необходимо использовать явную прав, необходимо запросить доступ для определенных типов данных и пользователь должен явно предоставить приложению доступ к этим типам данных.

В этой статье приведены:

- Требования к безопасности работоспособности пакета, включая подготовку приложения и запрашивает разрешение пользователя на доступ к базе данных работоспособности пакета;
- Система типов работоспособности пакета, что минимизирует вероятность применения опечатка или неправильной интерпретации данных;
- Записи в общий, системная хранилище данных работоспособности пакета.

В этой статье не рассматриваются дополнительные разделы, такие как запросы к базе данных, преобразования единиц измерения или получение уведомлений о новых данных.

В этой статье мы создадим образец приложения для записи пульс пользователя:

[![](healthkit-images/image01.png "Образец приложения для записи частота пульса пользователей")](healthkit-images/image01.png#lightbox)

## <a name="requirements"></a>Требования

Ниже перечислены необходимые условия для выполнения шагов, представленных в этой статье:

- **Xcode 7 и iOS 8 (или более поздней)** — последние Xcode и iOS API-интерфейсы Apple необходимо установить и настроить на компьютере разработчика.
- **Visual Studio для Mac или Visual Studio** — последнюю версию Visual Studio для Mac должен быть установлен и настроен на компьютере разработчика.
- **iOS 8 (или более поздней) устройства** — устройства iOS под управлением последней версии iOS 8 или больше для тестирования.

> [!IMPORTANT]
> **Примечание:** комплект работоспособности был введен в iOS 8. В настоящее время работоспособности пакета не доступен на симуляторе iOS и отладки требуется подключение к устройству физических операций ввода-вывода.




## <a name="creating-and-provisioning-a-health-kit-app"></a>Создание и подготовка работоспособности пакета приложения
Перед HealthKit API можно использовать это приложение Xamarin iOS 8, он должен быть правильно настроены и подготовить. В этом разделе мы рассмотрим шаги, необходимые для правильной установки приложения Xamarin.

Требовать работоспособности комплект средств для приложений:

- Явно **идентификатор приложения**.
- Объект **профиль подготовки** , связанных с явной **идентификатор приложения** и **комплект работоспособности** разрешения.
- `Entitlements.plist` С `com.apple.developer.healthkit` свойство типа `Boolean` значение `Yes`.
- `Info.plist` Которого `UIRequiredDeviceCapabilities` ключ содержит запись с `String` значение `healthkit`.
- `Info.plist` Также должны иметь соответствующие конфиденциальности объяснение записи: `String` объяснение ключа `NSHealthUpdateUsageDescription` Если приложение будет записывать данные и `String` объяснение ключа `NSHealthShareUsageDescription` Если предстоит прочитать работоспособности пакета приложения данные.

Чтобы узнать больше о подготовке приложения iOS [подготовки устройства](~/ios/get-started/installation/device-provisioning/index.md) статьи в Xamarin **Приступая к работе** рядов описывается связь между разработчика сертификаты, идентификаторы приложений Профили подготовки и прав приложения.

<a name="explicit-appid" />

### <a name="explicit-app-id-and-provisioning-profile"></a>Идентификатор явной приложения и подготовительного профиля

Создание явной **идентификатор приложения** и соответствующей **профиль подготовки** происходит в пределах компании Apple [центра разработки iOS](https://developer.apple.com/devcenter/ios/index.action). 

Ваши текущие **идентификаторы приложений** перечисленная в [сертификатов, профили & идентификаторы](https://developer.apple.com/account/ios/identifiers/bundle/bundleList.action) раздел в центре разработки. Часто, этот список будет отображать **идентификатор** значения `*`, означающее, **идентификатор приложения*- **имя** может использоваться с любым количеством суффиксы. Такие *идентификаторы приложений подстановочные* не может использоваться с комплекта работоспособности.
 
Чтобы создать явный **идентификатор приложения**, нажмите кнопку  **+**  кнопку в правом верхнем углу для перехода к **зарегистрировать идентификатор приложения iOS** страницы:


[![](healthkit-images/image02.png "Регистрация приложения на портале разработчиков Apple")](healthkit-images/image02.png#lightbox)

Как показано на рисунке выше, после создания описания приложения, используйте **явный идентификатор приложения** раздела, чтобы создать идентификатор для вашего приложения. В **службы приложений** установите флажок **комплект работоспособности** в **включить службы** раздела.

Закончив, нажмите клавишу **Продолжить** кнопку, чтобы зарегистрировать **идентификатор приложения** в вашей учетной записи. Вы будете перенаправлены обратно **сертификаты, идентификаторы и профили** страницы. Нажмите кнопку **профили подготовки** перейти к списку вашей текущей профили подготовки, а затем нажмите кнопку  **+**  кнопку в правом верхнем углу, чтобы перейти на **добавьте iOS Профиль подготовки** страницы. Выберите **разработки приложений iOS** и нажмите кнопку **Продолжить** для получения **выберите идентификатор приложения** страницы. Здесь также выбрать явных **идентификатор приложения** , указанное ранее:


[![](healthkit-images/image03.png "Выберите явный идентификатор приложения")](healthkit-images/image03.png#lightbox)

Нажмите кнопку **Продолжить** и могут работать через оставшиеся экраны, где вы зададите вашей **сертификаты разработчика**, **устройств**и **имя** для этого **профиль подготовки**:

[![](healthkit-images/image04.png "Создание профиля подготовки")](healthkit-images/image04.png#lightbox)

Нажмите кнопку **формирования** и ожидает создания профиля. Загрузите файл и дважды щелкните ее, чтобы установить в Xcode. Вы можете подтвердить его установки в разделе **Xcode > Параметры > учетные записи > Просмотр сведений о...** Должны быть значок для пакета работоспособности и другие специальные службы в, и вы увидите профиль подготовки устройства его **прав** строки:

[![](healthkit-images/image05.png "Просмотр профиля в Xcode")](healthkit-images/image05.png#lightbox)

<a name="associating-appid" />

### <a name="associating-the-app-id-and-provisioning-profile-with-your-xamarinios-app"></a>Сопоставления идентификатора приложения и подготовительного профиля с помощью приложения Xamarin.iOS

После создания и установки соответствующей **профиль подготовки** как было сказано, обычно было бы время для создания решения в Visual Studio для Mac или Visual Studio. Доступ к работоспособности Kit доступен на любой iOS C# или проект F #.

Вместо того, чтобы выполнить весь процесс создания проекта Xamarin iOS 8 вручную, откройте пример приложения, подключенные к этой статье (которая включает готовых раскадровки и кода). Для связи с комплектом работоспособности включен в пример приложения **профиль подготовки**в **Pad решения**, щелкните правой кнопкой мыши на проекте и подключить его **параметры** диалогового окна. Переключитесь в **приложение iOS** панели и введите явную **идентификатор приложения** созданный ранее в качестве приложения **идентификатор пакета**:

[![](healthkit-images/image06.png "Введите явный идентификатор приложения")](healthkit-images/image06.png#lightbox)

Теперь, переключитесь в **подписывание пакета iOS** панель. Ваш недавно установленные **профиль подготовки**, его связь с явным **идентификатор приложения**, теперь могут быть использованы как **профиль подготовки**:

[![](healthkit-images/image07.png "Выберите профиль подготовки")](healthkit-images/image07.png#lightbox)

Если **профиль подготовки** недоступно, следует внимательно **идентификатор пакета** в **приложение iOS** панели и который указан в **iOS Центр разработчиков** и что **профиль подготовки** установлен (**Xcode > Параметры > учетные записи > подробности...** ).

При поддержкой работоспособности комплект **профиль подготовки** —, нажмите кнопку **ОК** чтобы закрыть диалоговое окно параметров проекта.

### <a name="entitlementsplist-and-infoplist-values"></a>Entitlements.plist и Info.plist значения

Пример приложения включает `Entitlements.plist` файла (что необходимо для приложений с поддержкой Kit работоспособности) и не включается в каждый шаблон проекта. Если проект не имеет прав, щелкните правой кнопкой мыши проект, выберите **файл > новый файл... > iOS > Entitlements.plist** добавить его вручную.

В конечном счете ваш `Entitlements.plist` должна иметь следующие пару ключ-значение:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.developer.HealthKit</key>
    <true/>
</dict>
</plist>

```

Аналогичным образом `Info.plist` для приложения должна иметь значение `healthkit` связанных с `UIRequiredDeviceCapabilities` ключ:

```xml
<key>UIRequiredDeviceCapabilities</key>
<array>
<string>armv7</string>
    <string>healthkit</string>
</array>

```

Образец приложения, описываемых в этой статье включает предварительно настроенный `Entitlements.plist` , включает все необходимые ключи.

<a name="programming" />

## <a name="programming-health-kit"></a>Комплект средств для программирования работоспособности

Комплект средств для работоспособности хранилища данных является закрытым, пользовательские хранилища данных, являющихся общими для приложений. Так как сведения о работоспособности важна, положительное действия, чтобы разрешить доступ к данным должен выполнить пользователь. Разделяемыми могут быть этот доступ (записи, но не для чтения, доступ для некоторых типов данных, но не другие т. д.) и могут быть отменены в любое время. Работоспособность пакета приложений должны быть написаны очень осторожно, тот факт, что многие пользователи будут не решаться о хранении свои сведения о работоспособности.

Набор данных о работоспособности ограничена Apple определенных типов. Эти типы определены строго: другие, например тип крови ограничены определенные значения перечисления предоставленный Apple, пока другие объединить величиной с единицей измерения (например, грамм калорий и литрах). Даже данные, совместно использующих совместимые единица измерения различаются по их `HKObjectType`; в частности, в системе типов будет перехватывать ошибочный попытка сохранить `HKQuantityTypeIdentifier.NumberOfTimesFallen` значение поля, ответ `HKQuantityTypeIdentifier.FlightsClimbed` хотя оба используют` HKUnit.Count` Единица измерения.

Типы, хранимую в комплект работоспособности хранилища данных, всех подклассов `HKObjectType`. `HKCharacteristicType` объекты хранят биологических пол, крови и Дата рождения. Однако чаще будут `HKSampleType` объектов, которые представляют данные, используемого для выборки в определенное время или за определенный период времени. 

[![](healthkit-images/image08.png "HKSampleType объектов диаграммы")](healthkit-images/image08.png#lightbox)

`HKSampleType` является абстрактным и имеет четыре конкретных подклассов. В настоящее время имеется только один тип `HKCategoryType` данные, которые переходили в спящий режим анализа. Большую часть данных в пакете работоспособности относятся к типу `HKQuantityType` и хранить свои данные в `HKQuantitySample` объекты, которые создаются с помощью знакомых Фабричный конструктивный шаблон:

[![](healthkit-images/image09.png "Большую часть данных в пакете работоспособности относятся к типу HKQuantityType и хранить свои данные в объектах HKQuantitySample")](healthkit-images/image09.png#lightbox)

`HKQuantityType` типы в диапазоне от `HKQuantityTypeIdentifier.ActiveEnergyBurned` для `HKQuantityTypeIdentifier.StepCount`. 

<a name="requesting-permission" />

### <a name="requesting-permission-from-the-user"></a>Запрашивает разрешение пользователя

Конечным пользователям необходимо выполнить положительное действия, чтобы разрешить приложению чтение или запись данных работоспособности пакета. Это выполняется через работоспособности приложения, предварительно установленное на устройствах iOS 8. При первом запуске приложения Kit работоспособности, пользователю предоставляется с контролем системы **работоспособности доступ** диалогового окна:

[![](healthkit-images/image10.png "Пользователю предоставляется диалоговое окно, контролируемые системы работоспособности доступ")](healthkit-images/image10.png#lightbox)

Более поздней версии, пользователь может изменять разрешения с помощью работоспособности приложения **источников** диалогового окна:

[![](healthkit-images/image11.png "Пользователь может изменять разрешения с помощью диалогового окна источников приложений работоспособности")](healthkit-images/image11.png#lightbox)

Поскольку сведения о работоспособности очень важна, разработчикам приложений следует писать свои программы очень осторожно, исходя из предположения, что разрешения будет отклонено и изменять во время выполнения приложения. Наиболее распространенные идиому предназначена исключительно для запроса разрешений в `UIApplicationDelegate.OnActivated` метода и затем изменения пользовательского интерфейса соответствующим образом.

### <a name="permissions-walkthrough"></a>Пошаговое руководство разрешения

В проекте подготовкой Kit работоспособности откройте `AppDelegate.cs` файл. Обратите внимание на инструкции, использующей `HealthKit`; в верхней части файла.


Следующий код относится к работоспособности набор разрешений:

```csharp
private HKHealthStore healthKitStore = new HKHealthStore ();

public override void OnActivated (UIApplication application)
{
        ValidateAuthorization ();
}

private void ValidateAuthorization ()
{
        var heartRateId = HKQuantityTypeIdentifierKey.HeartRate;
        var heartRateType = HKObjectType.GetQuantityType (heartRateId);
        var typesToWrite = new NSSet (new [] { heartRateType });
        var typesToRead = new NSSet ();
        healthKitStore.RequestAuthorizationToShare (
                typesToWrite, 
                typesToRead, 
                ReactToHealthCarePermissions);
}

void ReactToHealthCarePermissions (bool success, NSError error)
{
        var access = healthKitStore.GetAuthorizationStatus (HKObjectType.GetQuantityType (HKQuantityTypeIdentifierKey.HeartRate));
        if (access.HasFlag (HKAuthorizationStatus.SharingAuthorized)) {
                HeartRateModel.Instance.Enabled = true;
        } else {
                HeartRateModel.Instance.Enabled = false;
        }
}

```

Весь код в этих методах можно воспользоваться встроенной `OnActivated`, но структура примера приложения используется отдельные методы, чтобы сделать их более четкое назначение: `ValidateAuthorization()` состоит из шагов, необходимых, чтобы запросить доступ для определенных типов записываемых (и чтения, при необходимости приложение) и `ReactToHealthCarePermissions()` является обратным вызовом, активируемый после с диалоговым окном разрешения в Health.app взаимодействовал пользователь.

Задача `ValidateAuthorization()` — Создание набора `HKObjectTypes` будет записи и запросить разрешение на обновление данных приложения. В примере приложения `HKObjectType` предназначается для ключа `KHQuantityTypeIdentifierKey.HeartRate`. Этот тип будет добавлен в набор `typesToWrite`, тогда как набор `typesToRead` остается пустой. Эти наборы, а также ссылку на `ReactToHealthCarePermissions()` обратный вызов, передается методу `HKHealthStore.RequestAuthorizationToShare()`.

`ReactToHealthCarePermissions()` Будет вызван обратный вызов после пользователь выполнял с диалоговым окном разрешения и передается два блока данных: `bool` значение, которое будет `true` Если пользователь взаимодействовать с ними диалоговое окно разрешений и `NSError`, если значение null, указывающая, каким-либо ошибки, связанной с предоставлением диалоговое окно разрешений.

> [!IMPORTANT]
> **Примечание:** Чтобы разобраться, аргументы данной функции: _успех_ и _ошибка_ параметры не обозначают ли пользователь имеет разрешения на доступ к данным работоспособности пакета! Только они указывают, что пользователь получил возможность разрешать доступ к данным.

Для подтверждения того, имеет ли приложение доступ к данным, `HKHealthStore.GetAuthorizationStatus()` используется, передав `HKQuantityTypeIdentifierKey.HeartRate`. На основе состояния возвращается, приложение включает или отключает возможность ввода данных. Нет стандартных удобная работа с отказ в доступе, и существует множество возможных параметров. В примере приложения, задано состояние `HeartRateModel` одноэлементный объект, который в свою очередь, создает соответствующие события.

## <a name="model-view-and-controller"></a>Модели, представления и контроллера

Чтобы просмотреть `HeartRateModel` одноэлементный объект откройте `HeartRateModel.cs` файл:

```csharp
using System;
using HealthKit;
using Foundation;

namespace HKWork
{
        public class GenericEventArgs<T> : EventArgs
        {
                public T Value { get; protected set; }
                public DateTime Time { get; protected set; }

                public GenericEventArgs (T value)
                {
                        this.Value = value;
                        Time = DateTime.Now;
                }
        }

        public delegate void GenericEventHandler<T> (object sender,GenericEventArgs<T> args);

        public sealed class HeartRateModel : NSObject
        {
                private static volatile HeartRateModel singleton;
                private static object syncRoot = new Object ();

                private HeartRateModel ()
                {
                }

                public static HeartRateModel Instance {
                        get {
                                //Double-check lazy initialization
                                if (singleton == null) {
                                        lock (syncRoot) {
                                                if (singleton == null) {
                                                        singleton = new HeartRateModel ();
                                                }
                                        }
                                }

                                return singleton;
                        }
                }

                private bool enabled = false;

                public event GenericEventHandler<bool> EnabledChanged;
                public event GenericEventHandler<String> ErrorMessageChanged;
                public event GenericEventHandler<Double> HeartRateStored;

                public bool Enabled { 
                        get { return enabled; }
                        set {
                                if (enabled != value) {
                                        enabled = value;
                                        InvokeOnMainThread(() => EnabledChanged (this, new GenericEventArgs<bool>(value)));
                                }
                        }
                }

                public void PermissionsError(string msg)
                {
                        Enabled = false;
                        InvokeOnMainThread(() => ErrorMessageChanged (this, new GenericEventArgs<string>(msg)));
                }

                //Converts its argument into a strongly-typed quantity representing the value in beats-per-minute
                public HKQuantity HeartRateInBeatsPerMinute(ushort beatsPerMinute)
                {
                        var heartRateUnitType = HKUnit.Count.UnitDividedBy (HKUnit.Minute);
                        var quantity = HKQuantity.FromQuantity (heartRateUnitType, beatsPerMinute);

                        return quantity;
                }
                        
                public void StoreHeartRate(HKQuantity quantity)
                {
                        var bpm = HKUnit.Count.UnitDividedBy (HKUnit.Minute);
                        //Confirm that the value passed in is of a valid type (can be converted to beats-per-minute)
                        if (! quantity.IsCompatible(bpm))
                        {
                                InvokeOnMainThread(() => ErrorMessageChanged(this, new GenericEventArgs<string> ("Units must be compatible with BPM")));
                        }

                        var heartRateId = HKQuantityTypeIdentifierKey.HeartRate;
                        var heartRateQuantityType = HKQuantityType.GetQuantityType (heartRateId);
                        var heartRateSample = HKQuantitySample.FromType (heartRateQuantityType, quantity, new NSDate (), new NSDate (), new HKMetadata());

                        using (var healthKitStore = new HKHealthStore ()) {
                                healthKitStore.SaveObject (heartRateSample, (success, error) => {
                                        InvokeOnMainThread (() => {
                                                if (success) {
                                                        HeartRateStored(this, new GenericEventArgs<Double>(quantity.GetDoubleValue(bpm)));
                                                } else {
                                                        ErrorMessageChanged(this, new GenericEventArgs<string>("Save failed"));
                                                }
                                                if (error != null) {
                                                        //If there's some kind of error, disable 
                                                        Enabled = false;
                                                        ErrorMessageChanged (this, new GenericEventArgs<string>(error.ToString()));
                                                }
                                        });
                                });
                        }
                }
        }
}

```

Первый раздел — это стандартный код для создания универсального события и обработчики. Начальная часть `HeartRateModel` класс также является стандартным для создания объекта одноэлементный потокобезопасным.

Затем `HeartRateModel` 3 событиями: 

- `EnabledChanged` — Указывает, что частота пульса хранилища включена или отключена (Обратите внимание, изначально отключенном хранилища). 
- `ErrorMessageChanged` -Это пример приложения, у нас есть очень простая модель обработки ошибок: строка с последней возникшей ошибки. 
- `HeartRateStored` — Вызывается, когда частота пульса хранится в комплект средств для работоспособности базы данных.

Обратите внимание, что каждый раз, когда происходят следующие события, выполняется через `NSObject.InvokeOnMainThread()`, которая позволяет подписчикам обновление пользовательского интерфейса. Кроме того события может быть описан в документации как возникшее в фоновых потоках и ответственность за обеспечение совместимости может остаться в их обработчики. Рекомендации по потока важны работоспособности комплект средств для приложений, так как многие функции, такие как запросы разрешения, являются асинхронными и выполнить их обратных вызовов в потоках, отличных от main.

Состоянием комплект средств для конкретного кода в `HeartRateModel` находится в двух функций `HeartRateInBeatsPerMinute()` и `StoreHeartRate()`. 

`HeartRateInBeatsPerMinute()` Преобразует аргумент в комплект строго типизированных работоспособности `HKQuantity`. Тип количества — это указано `HKQuantityTypeIdentifierKey.HeartRate` и единиц товара `HKUnit.Count` деленная `HKUnit.Minute` (другими словами, единица измерения — *подходит лучше, чем в минуту*). 

`StoreHeartRate()` Функция принимает `HKQuantity` (в примере приложения, он создан с `HeartRateInBeatsPerMinute()` ). Чтобы проверить свои данные, он использует `HKQuantity.IsCompatible()` метод, возвращающий `true` Если единицы объекта может быть преобразована в единицы измерения в аргументе. Если количество была создана с `HeartRateInBeatsPerMinute()` очевидно, что будет возвращен `true`, но также будет возвращать `true` Если количество были созданы как, например, *подходит лучше, чем на час*. Как правило `HKQuantity.IsCompatible()` может использоваться для проверки запоминающих устройств, расстояние и энергии, который пользователь или устройство может ввода или отображения в одной системе измерения (например, Имперский ед.), но которой может храниться в другой системе (например, показатель ед.). 

После проверки совместимости количества `HKQuantitySample.FromType()` фабричный метод используется для создания строго типизированного `heartRateSample` объекта. `HKSample` объекты имеют дату начала и окончания; для мгновенного показания эти значения должны быть теми же, как и в примере. Образец также не указывать данные ключ значение его `HKMetadata` аргументом, но один использовать код, например, следующий код для указания расположения датчика:

```csharp
var hkm = new HKMetadata();
hkm.HeartRateSensorLocation = HKHeartRateSensorLocation.Chest;

```

Один раз `heartRateSample` был создан, код создает новое подключение к базе данных с помощью блока. Внутри этого блока `HKHealthStore.SaveObject()` метод выполняет асинхронную запись в базу данных. Полученный вызов лямбда-выражение активирует соответствующие события либо `HeartRateStored` или `ErrorMessageChanged`.

Теперь, когда был запрограммирован модели, это время, чтобы определить, как контроллер отражает состояние модели. Откройте `HKWorkViewController.cs` файл. Конструктор просто сводит `HeartRateModel` единственного экземпляра методы обработки событий (опять же, это можно сделать внутри лямбда-выражения, но отдельные методы сделать немного более очевидным назначение):

```csharp
public HKWorkViewController (IntPtr handle) : base (handle)
{
     HeartRateModel.Instance.EnabledChanged += OnEnabledChanged;
     HeartRateModel.Instance.ErrorMessageChanged += OnErrorMessageChanged;
     HeartRateModel.Instance.HeartRateStored += OnHeartBeatStored;
}

```

Ниже приведены соответствующие обработчики.

```csharp
void OnEnabledChanged (object sender, GenericEventArgs<bool> args)
{
        StoreData.Enabled = args.Value;
        PermissionsLabel.Text = args.Value ? "Ready to record" : "Not authorized to store data.";
        PermissionsLabel.SizeToFit ();
}

void OnErrorMessageChanged (object sender, GenericEventArgs<string> args)
{
        PermissionsLabel.Text = args.Value;
}

void OnHeartBeatStored (object sender, GenericEventArgs<double> args)
{
        PermissionsLabel.Text = String.Format ("Stored {0} BPM", args.Value);
}

```

Очевидно, что в приложении с одним контроллером, можно избежать создания объекта отдельной модели и использование событий для потока управления, но использование модели объектов больше подходит для реальных приложений.

## <a name="running-the-sample-app"></a>Выполнение примера приложения

Симулятор iOS не поддерживает комплект средств для работоспособности. Отладка должны выполняться на физическом устройстве под управлением iOS 8.

Подключите устройство правильно подготовить iOS 8 разработки к системе. Выберите его в качестве цели развертывания в Visual Studio для Mac и выберите в меню **запуска > Отладка**.

> [!IMPORTANT]
> **Примечание:** ошибок, касающихся подготовки обнаружатся на этом этапе. Для устранения неполадок, просмотрите создания и подготовки в предыдущем разделе работоспособности пакета приложения. Существуют компоненты. 
>
> - **Центра разработки iOS** -явный идентификатор приложения & набор работоспособности включен профиль подготовки. 
> - **Параметры проекта** -идентификатор пакета (явный идентификатор приложения) & профиль подготовки.
> - **Исходный код** -Entitlements.plist & Info.plist

Предположим, что подготовка были правильно настроены, приложение запустится. При достижении его `OnActivated` метод, он запрашивает работоспособности комплект средств для авторизации. При первом запуске это встречается операционной системой пользователя появится следующее диалоговое окно:


[![](healthkit-images/image12.png "Пользователю будет предложено это диалоговое окно")](healthkit-images/image12.png#lightbox)

Разрешить приложение для обновления данных частота пульса и приложение появится на экране. `ReactToHealthCarePermissions` Обратный вызов будет активироваться асинхронно. Это приведет к `HeartRateModel’s` `Enabled` свойство, изменяемое, который будет вызывать `EnabledChanged` событие, которое вызовет `HKPermissionsViewController.OnEnabledChanged()` обработчик событий для запуска, которая обеспечивает `StoreData` кнопки. Следующая диаграмма показывает последовательность.


[![](healthkit-images/image13.png "Эта диаграмма показывает последовательность событий")](healthkit-images/image13.png#lightbox)

Нажмите клавишу **записи** кнопки. Это приведет к `StoreData_TouchUpInside()` обработчик для выполнения, который будет пытаться выполнить разбор значения `heartRate` текстовое поле, преобразовать в `HKQuantity` через обсуждалось ранее `HeartRateModel.HeartRateInBeatsPerMinute()` функции и передать это количество в `HeartRateModel.StoreHeartRate()`. Как отмечалось ранее, это будет пытаться хранения данных и будет вызывать либо `HeartRateStored` или `ErrorMessageChanged` событий.

Дважды щелкните **Главная** кнопку на устройстве и откройте работоспособности приложения. Нажмите кнопку **источников** вкладку, чтобы просмотреть пример приложения в списке. Выберите его и запретить разрешение на обновление данных частота пульса. Дважды щелкните **Главная** кнопки и вернитесь в приложение. Опять же `ReactToHealthCarePermissions()` будет вызван, но в этот раз, поскольку доступ запрещен, **StoreData** будет отключена кнопка (Обратите внимание, что это происходит в асинхронном режиме, и изменения в пользовательском интерфейсе могут быть видны конечному пользователю).

## <a name="advanced-topics"></a>Дополнительные разделы

Чтение данных из комплекта средств для работоспособности базы данных очень похож на запись данных: один определяет типы данных, один пытается получить доступ, авторизацию запросов, и при этом авторизация данные доступны, автоматическое преобразование совместимые устройства мера.

Существует несколько более сложных функций запроса на основе предикатов запросов и запросов, выполняющих обновления при обновлении важные данные. 

Разработчикам приложений набор работоспособности изучите разделе работоспособности Kit Apple [приложения просмотрите рекомендации](https://developer.apple.com/app-store/review/guidelines/#healthkit).

После понятны безопасности и система типов модели хранения и чтения данных в общей базе данных работоспособности Kit достаточно прост. Многие из функций в комплект работоспособности работает асинхронно, и разработчики приложений должны писать свои программы соответствующим образом.

На момент написания этой статьи, в настоящее время отсутствует эквивалент набору работоспособности в Android или Windows Phone.

## <a name="summary"></a>Сводка

В этой статье мы рассмотрели, как комплект работоспособности позволяет приложениям хранить получение и работоспособность общего ресурса сведения, связанные с, а также предоставляет стандартный работоспособности приложения, и позволяющая пользователю доступ и контроль над данным. 

Мы также увидели, как проблемы с работоспособностью сведения переопределении целостности данных, безопасности и конфиденциальности и приложений с помощью пакета работоспособности приходится иметь дело с увеличением сложности приложения управления аспектов (Подготовка), кодирование работоспособности Kit (тип система) и пользовательский интерфейс для использования (контроль разрешения посредством системных диалоговых окон и работоспособности приложения). 

Наконец у нас рассмотреть, простая реализация работоспособности пакета с помощью приложения включенный пример записывает данные пульса в хранилище работоспособности пакета с поддержкой асинхронных конструктора.

## <a name="related-links"></a>Связанные ссылки

- [HKWork (пример)](https://developer.xamarin.com/samples/monotouch/ios8/IntroToHealthKit/)
- [Введение в iOS 8](~/ios/platform/introduction-to-ios8.md)
