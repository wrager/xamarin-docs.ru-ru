---
title: "Push-уведомлений в iOS"
description: "В этом разделе мы рассмотрим push-уведомлений в iOS. Он представляет службу шлюза Apple Push-уведомления и роль, которую он играет в публикации уведомлений в приложения iOS. Он объясняется, как создать сертификаты безопасности, которые необходимо включить push-уведомления и обсуждения. Finally в этом разделе рассматриваются некоторые из задач обслуживания, которые серверы приложений должны быть выполнены для отслеживания клиенты мобильных устройств."
ms.topic: article
ms.prod: xamarin
ms.assetid: 64B3BE6A-A3E2-4B1B-95ED-02D27A8FDAAC
ms.technology: xamarin-ios
author: bradumbaugh
ms.author: brumbaug
ms.date: 03/18/2017
ms.openlocfilehash: 3af74fb9d93e22e361f2e3db00961d7955eda689
ms.sourcegitcommit: 73bd0c7e5f237f0a1be70a6c1384309bb26609d5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/22/2018
---
# <a name="push-notifications-in-ios"></a>Push-уведомлений в iOS

_В этом разделе мы рассмотрим push-уведомлений в iOS. Он представляет службу шлюза Apple Push-уведомления и роль, которую он играет в публикации уведомлений в приложения iOS. Он объясняется, как создать сертификаты безопасности, которые необходимо включить push-уведомления и обсуждения. Finally в этом разделе рассматриваются некоторые из задач обслуживания, которые серверы приложений должны быть выполнены для отслеживания клиенты мобильных устройств._

> [!IMPORTANT]
> Сведения в этом разделе, относятся к iOS 9 и предыдущий, она была оставлена здесь для поддержки более старых версий iOS. Для iOS, 10 и более поздней версии, см. в разделе [руководство по Framework уведомления пользователя](~/ios/platform/user-notifications/index.md) за поддержку локальных и удаленных уведомлений на устройства iOS.

Push-уведомлений, необходимо обеспечить краткое и содержать достаточно данных для уведомления мобильного приложения, его следует обратиться серверного приложения для обновления только. Например при поступлении новых сообщений электронной почты, серверное приложение только будет уведомления мобильного приложения поступления новых сообщений электронной почты. Уведомление по электронной почте сам не содержит. Мобильного приложения будет затем извлечь новых сообщений электронной почты с сервера во время соответствующие

В центре принудительной уведомления в iOS — *Apple Push Notification шлюза Service (APNS)*. Это служба компании Apple, отвечающий за маршрутизации уведомлений от сервера приложений на устройствах iOS.
На рисунке ниже показана топология принудительной уведомления для iOS: ![ ] (remote-notifications-in-ios-images/image4.png "это изображение иллюстрирует топологию уведомлений push для iOS")

Удаленный уведомления сами — это строки, которые соответствуют формату, отформатированное по JSON и протоколы, заданных в [полезные данные уведомления](https://developer.apple.com/library/prerelease/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CreatingtheNotificationPayload.html#//apple_ref/doc/uid/TP40008194-CH10-SW1) раздел [локальный и Push-уведомлений руководство по программированию](https://developer.apple.com/library/prerelease/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/)в [документации для разработчиков iOS](https://developer.apple.com/devcenter/ios/index.action).

Apple поддерживает две среды APNS: *"песочницы"* и *рабочей* среды. Среда "песочницы" предназначена для тестирования на этапе разработки и может быть найдено на `gateway.sandbox.push.apple.com` TCP-порт 2195. В рабочей среде предназначен для использования в приложениях, которые были развернуты и можно найти на `gateway.push.apple.com` TCP-порт 2195.

## <a name="requirements"></a>Требования

Push-уведомлений необходимо соблюдать следующие правила, которые определяются архитектурой APNS.

-  **256 байт ограничение сообщения** -размер всего сообщения уведомления не должен превышать 256 байт.
-  **Подтверждение поступления** -APNS не предоставляет отправителю уведомление, в которой сообщения предполагаемому получателю. Если несколько последовательных уведомления отправляются устройства недоступен, все уведомления, за исключением последней, будут потеряны. Только самые последние уведомления доставляются на устройстве.
-  **Каждое приложение необходим сертификат безопасности** -связь с APNS необходимо сделать по протоколу SSL.


## <a name="creating-and-using-certificates"></a>Создание и использование сертификатов

Каждая из этих сред, упомянутых в предыдущем разделе требует свой собственный сертификат. В этом разделе мы рассмотрим, как создать сертификат, свяжите его с использованием подготовительного профиля и затем получить сертификат обмена персональными данными для использования с PushSharp.

1.  Для создания сертификатов перейдите на iOS подготовки портала на веб-сайте Apple, как показано на следующем снимке экрана (Обратите внимание, пункт меню идентификаторы приложений слева):

    [![](remote-notifications-in-ios-images/image5new.png "Портал Провизионирования на веб-сайте яблоки iOS")](remote-notifications-in-ios-images/image5new.png#lightbox)

2.  Затем перейдите к разделу приложения идентификаторов и создать новый идентификатор приложения, как показано на следующем снимке экрана:

    [![](remote-notifications-in-ios-images/image6new.png "Перейдите к разделу идентификаторы приложений и создать новый идентификатор приложения")](remote-notifications-in-ios-images/image6new.png#lightbox)

3.  При нажатии кнопки на  **+**  кнопки, можно ввести описание и идентификатор пакета для идентификатора приложения, как показано на следующем снимке экрана:

    [![](remote-notifications-in-ios-images/image7new.png "Введите описание и идентификатор пакета для идентификатора приложения")](remote-notifications-in-ios-images/image7new.png#lightbox)

4. Убедитесь в том выбрать **явный идентификатор приложения** и идентификатор пакета не заканчивается `*` . Это создаст идентификатор, который хорошо подходит для нескольких приложений, и принудительной уведомления сертификаты должны быть для одного приложения.

1. Установите службы приложения, **Push-уведомления**:

    [![](remote-notifications-in-ios-images/image8new.png "Выберите Push-уведомлений")](remote-notifications-in-ios-images/image8new.png#lightbox)

2. И нажмите клавишу **отправить** для подтверждения регистрации нового идентификатора приложения:

    [![](remote-notifications-in-ios-images/image9new.png "Подтверждение регистрации нового идентификатора приложения")](remote-notifications-in-ios-images/image9new.png#lightbox)

3.  Далее необходимо создать сертификат для идентификатора приложения. В панели навигации слева найдите **сертификаты > все** и выберите `+` кнопки, как показано на следующем снимке экрана:

    [![](remote-notifications-in-ios-images/image10new.png "Создание сертификата для идентификатора приложения")](remote-notifications-in-ios-images/image8.png#lightbox)

4.  Выберите, будут ли вы хотели бы использовать сертификат разработки или рабочей среде:

    [![](remote-notifications-in-ios-images/image11new.png "Выберите сертификат, разработки или производства")](remote-notifications-in-ios-images/image11new.png#lightbox)

5. А затем выберите новый идентификатор приложения, который мы только что создали.

    [![](remote-notifications-in-ios-images/image12new.png "Выберите только что созданный новый идентификатор приложения")](remote-notifications-in-ios-images/image12new.png#lightbox)

6.  При этом отобразится инструкциям проведет вас через процесс создания *запрос подписи сертификата* с помощью **доступ к цепочке ключей** приложение на компьютере Mac.

7.  После создания сертификата он должен использоваться как часть процесса построения для входа приложения, чтобы он может зарегистрироваться в APNs. Для этого необходимо создать и установить профиль подготовки, использующего сертификат.

8.  Чтобы создать профиль подготовки разработки, перейдите в папку **профили подготовки** раздел и выполните действия, чтобы создать его, используя только что созданный идентификатор приложения.

9.  После создания профиля подготовки, откройте **Xcode Организатор** и обновить его. При создании профиля подготовки не отображается, может оказаться необходимым загрузить профиль с портал Провизионирования iOS и импортировать его вручную. На следующем снимке экрана показан пример организатора добавлены профиль подготовки:

    [![](remote-notifications-in-ios-images/image13new.png "Этот снимок экрана: пример Организатор с профиль подготовки, добавленный")](remote-notifications-in-ios-images/image13new.png#lightbox)

10.  На этом этапе необходимо настроить проект для использования нового профиля подготовки Xamarin.iOS. Это делается с **параметры проекта** диалогового окна в разделе **подписывание пакета iOS** вкладки, как отображение на следующем снимке экрана:

    [![](remote-notifications-in-ios-images/image11.png "Настройка Xamarin.iOS проект для использования нового профиля подготовки")](remote-notifications-in-ios-images/image11.png#lightbox)



На этом этапе приложение настроено для работы с push-уведомлений. Тем не менее по-прежнему существует несколько дополнительных действий, необходимо с помощью сертификата. Этот сертификат находится в формате DER, который несовместим с PushSharp, что требует сертификата обмена личной информацией (PKCS12). Чтобы преобразовать сертификат, чтобы он был доступен для PushSharp, выполнения этих действий:

1.  **Загрузите файл сертификата** -вкладка "Сертификаты" выберите имя входа на портал Провизионирования iOS, выберите сертификат, связанный с правильный профиль подготовки и выбрал **загрузить** .
1.  **Откройте доступ к цепочке ключей** -это приложение имеет Графический интерфейс пользователя в систему управления пароль в OS X.
1.  **Импортируйте сертификат** — Если сертификата еще не установлен, **файла... Импорт элементов** меню доступ к цепочке ключей. Перейдите к сертификату, экспортировать выше и выберите его.
1.  **Экспорт сертификата** - разверните сертификат, чтобы соответствующий закрытый ключ был виден, щелкните правой кнопкой мыши на ключ и выбрали экспорта. Будут запрашиваться имя файла и пароль для экспортированного файла.

На этом этапе мы выполняются с помощью сертификатов. Мы создали сертификат, который будет использоваться для подписывания приложений iOS и преобразовать этот сертификат в формате, который может использоваться с PushSharp в серверном приложении. Далее рассмотрим взаимодействие приложений iOS с APNS.

## <a name="registering-with-apns"></a>Регистрация в APNS

Прежде чем iOS приложение может получить удаленный уведомления, его необходимо зарегистрировать в APNS. APNS создаст токен уникальный устройства и возврат, приложение iOS. Приложение iOS будет предпринимать токен устройства и самостоятельной регистрации на сервере приложений. После этого все регистрации завершена, и сервер приложений может push-уведомления на мобильное устройство.

В теории маркер устройства может меняться при каждом запуске приложения iOS регистрирует себя с APNS, однако на практике это не происходит, часто. Для оптимизации приложения может кэшировать последних токен устройства и обновить сервер приложений только при его изменении. Следующая схема иллюстрирует процесс регистрации и получения токен устройства:

 ![](remote-notifications-in-ios-images/image12.png "На этой схеме показан процесс регистрации и получив токен устройства")

Регистрация в APNS обрабатывается в `FinishedLaunching` метод класса делегата приложения путем вызова `RegisterForRemoteNotificationTypes` в текущем `UIApplication` объекта. При регистрации приложения iOS APNS, его необходимо также указать, какие виды удаленного уведомления следует получать. Эти уведомления удаленного типы объявляются в перечислении `UIRemoteNotificationType`. В следующем фрагменте кода приведен пример как приложение iOS может зарегистрироваться для получения удаленных оповещений и эмблемы уведомления:

```csharp
if (UIDevice.CurrentDevice.CheckSystemVersion (8, 0)) {
    var pushSettings = UIUserNotificationSettings.GetSettingsForTypes (
                       UIUserNotificationType.Alert | UIUserNotificationType.Badge | UIUserNotificationType.Sound,
                       new NSSet ());

    UIApplication.SharedApplication.RegisterUserNotificationSettings (pushSettings);
    UIApplication.SharedApplication.RegisterForRemoteNotifications ();
} else {
    UIRemoteNotificationType notificationTypes = UIRemoteNotificationType.Alert | UIRemoteNotificationType.Badge | UIRemoteNotificationType.Sound;
    UIApplication.SharedApplication.RegisterForRemoteNotificationTypes (notificationTypes);
}
```

Запрос на регистрацию APNS происходит в фоновом режиме - при получении ответа iOS вызывает метод `RegisteredForRemoteNotifications` в `AppDelegate` класса и передавать токен зарегистрированного устройства. Токен будет содержаться в `NSData` объекта. В следующем фрагменте кода показано, как получить токен устройства, APNS указано:

```csharp
public override void RegisteredForRemoteNotifications (
UIApplication application, NSData deviceToken)
{
    // Get current device token
    var DeviceToken = deviceToken.Description;
    if (!string.IsNullOrWhiteSpace(DeviceToken)) {
        DeviceToken = DeviceToken.Trim('<').Trim('>');
    }

    // Get previous device token
    var oldDeviceToken = NSUserDefaults.StandardUserDefaults.StringForKey("PushDeviceToken");

    // Has the token changed?
    if (string.IsNullOrEmpty(oldDeviceToken) || !oldDeviceToken.Equals(DeviceToken))
    {
        //TODO: Put your own logic here to notify your server that the device token has changed/been created!
    }

    // Save new device token
    NSUserDefaults.StandardUserDefaults.SetString(DeviceToken, "PushDeviceToken");
}
```

Если регистрация завершится ошибкой, для какой-либо причине (например, устройство не подключено к Интернету), iOS будет вызывать `FailedToRegisterForRemoteNotifications` класс делегата в приложении. В следующем фрагменте кода показан способ отображения предупреждения пользователю о том, что не удалось выполнить регистрацию.

```csharp
public override void FailedToRegisterForRemoteNotifications (UIApplication application , NSError error)
{
    new UIAlertView("Error registering push notifications", error.LocalizedDescription, null, "OK", null).Show();
}
```

### <a name="device-token-housekeeping"></a>Токен вспомогательные устройства

Токены устройств будет срок действия или изменяться со временем. По этой причине серверные приложения потребуется выполнить некоторые очистки дома и очистить эти токены с истекшим сроком действия или измененные. Когда приложение передает как push-уведомление на устройство, которое имеет просроченного маркера, APNS будет записать и сохранить этот маркер истекшим сроком действия. Серверы могут запросить APNS, чтобы узнать, какие маркеры, истек срок действия.

APNS используется для предоставления *службы обратной связи* -конечная точка HTTPS, выполняющий проверку подлинности посредством созданных отправлять push уведомления и отправляет назад данные об какие токены, истек срок действия сертификатов. Это рекомендуется в Apple и удалена.

Вместо этого используется новый код состояния HTTP для случая, который ранее сообщил обратной связи службы:

> 410 - токен устройства больше не активна, см. в разделе.

Кроме того, новые `timestamp` ключ данных JSON будет находиться в тексте ответа:

> Если значение в: заголовок состояние — 410, значение этого параметра — время последнего, по которому APN подтверждает, что токен устройства больше не является допустимым см. в разделе.
>
> Остановите принудительной отправки уведомления, пока устройство регистрируется маркер с более поздней отметкой времени с помощью поставщика.

## <a name="summary"></a>Сводка

В этом разделе представлены основные понятия вокруг push-уведомлений в iOS. Он описывается роль из Apple Push Notification шлюза Service (APNS). Затем он рассматривается создание и использование сертификатов безопасности, которые необходимы для APNS. Finally в этом документе завершения с обсуждения о том, как серверы приложений можно использовать *службы обратной связи* на прекращение отслеживания истек срок действия токенов устройства.


## <a name="related-links"></a>Связанные ссылки

- [Уведомления - демонстрации локальных и удаленных уведомления (пример)](https://developer.xamarin.com/samples/monotouch/Notifications/)
- [Локальные и Push-уведомления для разработчиков](https://developer.apple.com/notifications/)
- [UIApplication](http://iosapi.xamarin.com/?link=T%3aMonoTouch.UIKit.UIApplication)
- [UIRemoteNotificationType](http://iosapi.xamarin.com/?link=T%3aMonoTouch.UIKit.UIRemoteNotificationType)
